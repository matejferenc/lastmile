<!DOCTYPE html>
<html>
<head>
    <title>Place Autocomplete</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #description {
        font-family: Roboto;
        font-size: 15px;
        font-weight: 300;
      }

      #infowindow-content .title {
        font-weight: bold;
      }

      #infowindow-content {
        display: none;
      }

      #map #infowindow-content {
        display: inline;
      }

      #title {
        color: #fff;
        background-color: #4d90fe;
        font-size: 25px;
        font-weight: 500;
        padding: 6px 12px;
      }
      #user-input-panel {
        width: 30%;
        float: left;
      }
      #distance {

      }
      form {
        padding: 20px;
      }
      .requestItem {
        height: 30px;
        cursor: pointer;
      }
    </style>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap-datetimepicker.min.css">

</head>
<body>
<script src="js/jquery-3.2.1.min.js"></script>
<script src="js/bootstrap-datetimepicker.min.js"></script>
<script src="js/bootstrap.js"></script>
<div id="user-input-panel">
    <form class="form-group">
    <h2>Create an offer</h2>
    <input id="refreshButton" onclick="refresh(); return false;" type="submit" value="Refresh map" class="btn btn-primary">
    <br/>
    <div id="result-list"></div>

    <br/>
    <label for="price">Price:</label>
    <input id="price" type="text" class="form-control">
    <input id="submitButton" onclick="offer(); return false;" type="submit" value="Create an offer" class="btn btn-primary">
    <br/>
    </form>
</div>
<div id="map"></div>
<div id="infowindow-content">
    <img src="" width="16" height="16" id="place-icon">
    <span id="place-name"  class="title"></span><br>
    <span id="place-address"></span>
</div>

<script>

var map;
var directionsService;

var data =
    [
        {
            id: 1,
            origin: {lat: 50.1058987, lng: 14.2688662},
            destination: {lat: 50.1612703, lng: 14.2593538}
        },
        {
            id: 2,
            origin: {lat: 50.1058987, lng: 14.2688662},
            destination: {lat: 49.9478347, lng: 14.1045045}
        },
        {
            id: 3,
            origin: {lat: 50.1058987, lng: 14.2688662},
            destination: {lat: 49.6010519, lng: 14.1875919}
        },
        {
            id: 4,
            origin: {lat: 50.0831588, lng: 14.435583},
            destination: {lat: 50.2701679, lng: 14.3296028}
        },
        {
            id: 5,
            origin: {lat: 50.0831588, lng: 14.435583},
            destination: {lat: 50.1282272, lng: 13.4471977}
        }
    ]
;

function refresh() {
    for (i = 0; i < data.length; i++) {
        var originGps = data[i].origin;
        var destinationGps = data[i].destination;
        var id = data[i].id;

        createMarker(originGps);
        createInvisibleEndMarker(destinationGps);

        createResultRow(id, originGps, destinationGps);

    }
};


var directionsDisplay;
var endMarker;
var activeId;
function drawPath(id) {
    if (activeId && activeId == id) {
        return;
    };

    activeId = id;
console.log("drawing path for id: " + id);
    var item;
    for (i = 0; i < data.length; i++) {
        if (data[i].id == id) {
            item = data[i];
            break;
        }
    }
    var originGps = item.origin;
    var destinationGps = item.destination;
    var id = item.id;

    if (endMarker) {
        endMarker.setMap(null);
    }

    endMarker = createMarker(destinationGps);

    var request = {
        origin: originGps,
        destination: destinationGps,
        travelMode: google.maps.TravelMode.DRIVING
    };

    directionsDisplay.setMap(null);
    directionsDisplay.setMap(map);
    directionsService.route(request, function (response, status) {
        if (status == google.maps.DirectionsStatus.OK) {
            directionsDisplay.setDirections(response);
        } else {
            console.log("error directionsService");
        }
    });
}

function createResultRow(id, originGps, destinationGps) {
    var service = new google.maps.DistanceMatrixService();
    service.getDistanceMatrix({
        origins: [originGps],
        destinations: [destinationGps],
        travelMode: google.maps.TravelMode.DRIVING,
        unitSystem: google.maps.UnitSystem.METRIC,
        avoidHighways: false,
        avoidTolls: false
    }, function (response, status) {
        if (status == google.maps.DistanceMatrixStatus.OK && response.rows[0].elements[0].status != "ZERO_RESULTS") {
            var distance = response.rows[0].elements[0].distance.text;
            var duration = response.rows[0].elements[0].duration.text;
            console.log("Distance: " + distance);
            console.log("Duration:" + duration);

            $('#result-list').append("<div id='request-item-" + id + "' class='requestItem' onclick='selectRequest(" + id + ")'><img src='img/search_icon.png' onmousemove='drawPath(" + id + ");'><span>" + distance + "</span>, <span>" + duration + "</span></div>");
        }
    });
}

function offer() {
};

function selectRequest(id) {
    for (i = 0; i < data.length; i++) {
        if (data[i].id == id) {
            item = data[i];
            $('#request-item-' + id).css('background-color', 'lightblue');
        } else {
            $('#request-item-' + data[i].id).css('background-color', '');
        }
    }
}

function createInvisibleEndMarker(position) {
    var marker = new google.maps.Marker({
      map: map,
      anchorPoint: new google.maps.Point(0, -29)
    });
    marker.setPosition(position);
    marker.setVisible(false);

    var current_bounds = map.getBounds();
      var marker_pos = marker.getPosition();

      if( !current_bounds.contains( marker_pos ) ){
        var new_bounds = current_bounds.extend( marker_pos );
        map.fitBounds( new_bounds );
      }
};

function createMarker(position) {
    var marker = new google.maps.Marker({
      map: map,
      anchorPoint: new google.maps.Point(0, -29)
    });
    marker.setPosition(position);
    marker.setVisible(true);

    var current_bounds = map.getBounds();
      var marker_pos = marker.getPosition();

      if( !current_bounds.contains( marker_pos ) ){
        var new_bounds = current_bounds.extend( marker_pos );
        map.fitBounds( new_bounds );
      }
    return marker;
};

$('.datepicker').datetimepicker({
    format: 'yyyy-mm-dd hh:ii'
});


$.postJSON = function(url, data, callback) {
    return $.ajax({
        'type': 'POST',
        'url': url,
        'contentType': 'application/json',
        'data': JSON.stringify(data),
        'dataType': 'json',
        'success': callback,
        headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        }
    });
};


      // This example requires the Places library. Include the libraries=places
      // parameter when you first load the API. For example:
      // <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places">

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 50.0755, lng: 14.4378},
          zoom: 10
        });
        var types = document.getElementById('type-selector');
        var strictBounds = document.getElementById('strict-bounds-selector');


        google.maps.event.addListener(map, "click", function (e) {
            //lat and lng is available in e object
            var latLng = e.latLng;
            console.log(latLng);
        });

        directionsService = new google.maps.DirectionsService();
        directionsDisplay = new google.maps.DirectionsRenderer({ 'draggable': false, 'preserveViewport': true});
        directionsDisplay.setMap(map);

      };
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBERgplsRjMcAkFoTcFVeq5Q7--TKxLVPA&libraries=places&callback=initMap"
        async defer></script>
</body>
</html>